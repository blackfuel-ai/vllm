# Lightweight CPU-only vLLM image for benchmarking (vllm bench).
#
# Drops multimodal deps (torchaudio, torchvision, opencv, ffmpeg),
# grammar engines (xgrammar, outlines, llguidance), and other
# serving-only packages to produce a much smaller image.
#
# Build:
#   docker buildx build --platform=linux/amd64 \
#     -f docker/Dockerfile.cpu-bench -t vllm-cpu-bench .
#
# Run:
#   docker run --rm vllm-cpu-bench bench latency \
#     --model <model> --input-len 32 --output-len 128 --batch-size 1

######################### BASE #########################
FROM ubuntu:22.04 AS base

WORKDIR /workspace

ARG PYTHON_VERSION=3.12
ARG PIP_EXTRA_INDEX_URL="https://download.pytorch.org/whl/cpu"

# Minimal system packages â€” no ffmpeg/libgl1/libsm6/libxext6
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update -y \
    && apt-get install -y --no-install-recommends \
       sudo git curl wget ca-certificates ccache \
       gcc-12 g++-12 libtcmalloc-minimal4 libnuma-dev \
    && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 \
       --slave /usr/bin/g++ g++ /usr/bin/g++-12 \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && rm -rf /var/lib/apt/lists/*

ENV CC=/usr/bin/gcc-12 CXX=/usr/bin/g++-12
ENV PATH="/root/.local/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
ENV UV_PYTHON_INSTALL_DIR=/opt/uv/python
RUN uv venv --python ${PYTHON_VERSION} --seed ${VIRTUAL_ENV}
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

ENV PIP_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_INDEX_STRATEGY="unsafe-best-match"
ENV UV_LINK_MODE="copy"
ENV UV_HTTP_TIMEOUT=500

# Install only the minimal bench dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,src=requirements/cpu-bench.txt,target=requirements/cpu-bench.txt \
    uv pip install --upgrade pip && \
    uv pip install -r requirements/cpu-bench.txt

######################### BUILD #########################
FROM base AS build

ARG max_jobs=4
ENV MAX_JOBS=${max_jobs}

ARG VLLM_CPU_DISABLE_AVX512=true
ARG VLLM_CPU_AVX512BF16=false
ARG VLLM_CPU_AVX512VNNI=false
ARG VLLM_CPU_AMXBF16=false
ENV VLLM_CPU_DISABLE_AVX512=${VLLM_CPU_DISABLE_AVX512}
ENV VLLM_CPU_AVX512BF16=${VLLM_CPU_AVX512BF16}
ENV VLLM_CPU_AVX512VNNI=${VLLM_CPU_AVX512VNNI}
ENV VLLM_CPU_AMXBF16=${VLLM_CPU_AMXBF16}

ENV CCACHE_DIR=/root/.cache/ccache
ENV CMAKE_CXX_COMPILER_LAUNCHER=ccache

WORKDIR /workspace/vllm

RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,src=requirements/cpu-build.txt,target=requirements/build.txt \
    uv pip install -r requirements/build.txt

COPY . .

RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=cache,target=/root/.cache/ccache \
    --mount=type=cache,target=/workspace/vllm/.deps,sharing=locked \
    --mount=type=bind,source=.git,target=.git \
    VLLM_TARGET_DEVICE=cpu python3 setup.py bdist_wheel --dist-dir=dist --py-limited-api=cp38

######################### FINAL #########################
FROM base AS vllm-cpu-bench

ENV LD_PRELOAD="/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4:/opt/venv/lib/libiomp5.so"

# Install the wheel without its declared deps (we already have the minimal set)
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,from=build,src=/workspace/vllm/dist,target=/tmp/dist \
    uv pip install --no-deps /tmp/dist/*.whl

# Only copy benchmarks (not tests/examples)
COPY benchmarks/ /workspace/benchmarks/

RUN echo 'ulimit -c 0' >> ~/.bashrc

ENTRYPOINT ["vllm"]
